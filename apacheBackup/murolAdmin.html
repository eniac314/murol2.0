<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  
  <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.0.0/webcomponents-bundle.js" type="text/javascript"></script>
  <script type="text/javascript" src="js/MurolAdmin.js"></script>
  <script type='text/javascript' src='js/PortFunnel.js'></script>


</head>


  

<body>

  <script type="text/javascript">
    var app = Elm.MurolAdmin.init({flags: {availableThreads: window.navigator.hardwareConcurrency || 1 }});

    app.ports.toImageProcessor.subscribe(function(d){
      processImage(d);
    });



    // PortFunnel.subscribe will load js/PortFunnel/<module>.js,
    // for each module in this list.
    var modules = ['LocalStorage'];

    PortFunnel.subscribe(app, {modules: modules});
    
    /////////////////////////////////////////////////////////////////
    
    customElements.define('custom-textarea', class extends HTMLElement {
    
      constructor(){
        super();
        
      }
      
      get selection(){
        return this._currentSelection || "no selection";  
      }

      get cols(){
        return this._cols || "0";
      }

      set selection(offset){
        if(offset !== null) {
          if (this.querySelector('textarea') !== null){
            this._textarea = this.querySelector('textarea');
            this._textarea.focus();
            this._textarea.setSelectionRange(offset.start,offset.stop);
          }
        }
      }

      connectedCallback() {
        this._textarea = this.querySelector('textarea');
            
        this._textarea.addEventListener('click', (event) => {
            
          var start = this._textarea.selectionStart;
          var finish = this._textarea.selectionEnd;
          var sel = this._textarea.value.substring(start, finish);

           this._currentSelection = 
               { start: start, 
                 finish: finish,
                 sel: sel
               };

          this.dispatchEvent(new CustomEvent('Selection'));
        }); 
      
      }
    });

    /////////////////////////////////////////////////////////////////

    customElements.define('uploads-controller', class extends HTMLElement {
      
      get fileDict(){
        return this._fileDict || {};
      }

      set uploadPath(path){
        this._uploadPath = path;
      }

      set uploadScript(scriptName){
        this._uploadScript = scriptName;
      }

      set sendFiles(sessionId){
        if(sessionId !== "" && this._uploadPath !== null && this._uploadScript !== null) {
          for (var filename in this._fileDict){
            sendFile(this._fileDict[filename]['file'],sessionId, this);
          }
          // this.dispatchEvent(new CustomEvent('uploadDone'));
        } 
      }

      connectedCallback() {

        console.log("connectedCallback")
    
        this._input = this.querySelector('input');

        this._input.addEventListener('change', (event) => {
          
        this._fileDict = {};
        var files = this._input.files;
        
        for (var i = 0; i < files.length; i++){
          var fileEntry = 
            { "file" : files[i]
            , "filename" : files[i].name
            , "loaded" : null
            , "total" : null
            , "success" : null
            };

          this._fileDict[files[i].name] = fileEntry; 
          
        }
            
          
        this.dispatchEvent(new CustomEvent('filesInput'));       
 
        });
      }

    });

    sendFile = function (file, sessionId, caller) {
      var formData = new FormData();
      var request = new XMLHttpRequest();
   
      formData.set('file', file);
      formData.set('sessionId',sessionId);
      formData.set('uploadPath', caller._uploadPath);      

      request.upload.addEventListener('progress', (event) => {

        if (event.lengthComputable) {

          // const progress = event.loaded / event.total * 100;
          caller._fileDict[file.name].loaded = event.loaded;
          caller._fileDict[file.name].total = event.total;          
          caller.dispatchEvent(new CustomEvent('uploadProgress'));
        }
      
      });

      request.onload = function () {
        if (request.readyState === request.DONE) {
          if (request.status === 200) {
              caller._fileDict[file.name].success = request.response;
              caller.dispatchEvent(new CustomEvent('uploadProgress'));
              // console.log(request.response);
              // console.log(request.responseText);
          }
        }
      };

      request.open("POST", caller._uploadScript);
      request.responseType = 'json';

      request.send(formData);
    };

  ///////////////////////////////////////////////////////////////////

   

  customElements.define('image-controller', class extends HTMLElement {

    get fileData(){
      return this._fileData || "???";
    }

    set desiredSize(maxHeight){
      if (maxHeight != null && this._original != null) {
        this._maxHeight = maxHeight;
        // resize(this._original.contents, maxHeight, this._original.filename, this);
        transform(this._original.contents,this._original.filename, this);
      }
    }
    
    set rotationAngle(rAngle){
      // console.log("test");
      if (rAngle != null && this._original != null){
        this._rAngle = rAngle;
        // rotateImage(this._original.contents, rAngle, this._original.filename, this);
        transform(this._original.contents,this._original.filename, this);
      }
    }

    connectedCallback() {
    
      this._input = this.querySelector('input');
      
      this._input.addEventListener('change', (event) => {
      
        var file = this._input.files[0];
        var reader = new FileReader();
        
        

        reader.onload = ((event) => {
          
          var base64encoded = event.target.result;
          
          var image = new Image();

          image.onload = () => {

            var fileData = {
              contents: base64encoded,
              filename: file.name,
              width: image.width,
              height: image.height,
              filesize: fileSize(base64encoded)
            };
            
            this._fileData = fileData;
            this._original = fileData;
            this._maxHeight = image.height;
            this._rAngle = 0;

            this.dispatchEvent(new CustomEvent('fileRead'));
          };

          image.src = base64encoded;

          
        });

        reader.readAsDataURL(file);
   
      });
    }
  });

  function fileSize(src){
    var stringLength = src.length - 'data:image/jpeg;base64,'.length;

    var sizeInBytes = 4 * Math.ceil((stringLength / 3))*0.5624896334383812;
    var sizeInKb=sizeInBytes/1024;
    return Math.round(sizeInBytes);
  }

  function resize(src, max_height, filename, caller){
  
    var image = new Image();
    image.onload = function(){
      var canvas = document.createElement('canvas');
      if(image.height > max_height) {
        image.width *= max_height / image.height;
        image.height = max_height;
      }
  
        if(image.height > max_height) {
          image.width *= max_height / image.height;
          image.height = max_height; 
        }
     

      var ctx = canvas.getContext("2d");
      
      canvas.width = image.width;
      canvas.height = image.height;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0, image.width, image.height);
      
      // var blob = canvas.toBlob(function(b) {return b;},"image/jpeg",1);
      
      // console.log(blob);

      var data = canvas.toDataURL("image/jpeg");
      // var data = blobToDataURL(blob);  

      var fileData = {
              contents: data,
              filename: filename,
              width: image.width,
              height: image.height,
              filesize: fileSize(data)
            };
            
      caller._fileData = fileData;
      
      rotateImage(fileData.contents, caller._rAngle, caller._original.filename, caller);

      
    };
    
    image.src = src;
    }

  function rotateImage(src, rAngle, filename, caller){
      var image = new Image();
      
      image.onload = function(){
        var canvas = document.createElement('canvas');
        
        var ctx = canvas.getContext("2d");
        
        if(rAngle == 90 || rAngle == 270) {
          canvas.width = image.height;
          canvas.height = image.width;
        } else {
          canvas.width = image.width;
          canvas.height = image.height;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        

        if(rAngle == 90 || rAngle == 270) {
          ctx.translate(image.height/2,image.width/2);
        } else {
          ctx.translate(image.width/2,image.height/2);
        }
        ctx.rotate(rAngle*Math.PI/180);
        ctx.drawImage(image,-image.width/2,-image.height/2);

        var data = canvas.toDataURL("image/jpeg",0.90);  

        var fileData = {
                contents: data,
                filename: filename,
                width: canvas.width,
                height: canvas.height,
                filesize: fileSize(data)
              };
              
        caller._fileData = fileData;

        caller.dispatchEvent(new CustomEvent('imageRead'));
      };
    
    image.src = src;
    } 
    
    
    function transform(src, filename, caller){
        resize(caller._original.contents, caller._maxHeight, caller._original.filename, caller);
     
    }
    
   ////////////////////////////////////////////////////////////////////////////
   
   function processImage(data){

      var image = new Image();
      
      image.onload = function(){
        
        var canvas = document.createElement('canvas');

        if(image.height > 600) {
          var width = image.width * 600 / image.height;
          var height = 600;
        } else {
          var width = image.width;
          var height = image.height;
        }

        var ctx = canvas.getContext("2d");
        
        
        canvas.width = width;
        canvas.height = height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(image, 0, 0, width, height);
        var smallPic = canvas.toDataURL("image/jpeg",0.90);
        
        
        var thumbSize = Math.min(image.width, image.height);
        
        if (image.width > image.height){
          var sx = (Math.floor((image.width - image.height)/2));
          var sy = 0; 
        } else {
          var sx = 0;
          var sy = (Math.floor((image.height - image.width)/4));
        }

        var thumbCanvas = document.createElement('canvas');
        thumbCanvas.width = 200;
        thumbCanvas.height = 200;
        
        var tCtx = thumbCanvas.getContext("2d");
        tCtx.clearRect(0,0,200,200);
        

        tCtx.drawImage(image, sx, sy, thumbSize, thumbSize, 0, 0, 200, 200);
        var thumb = thumbCanvas.toDataURL("image/jpeg",0.9);

        var result = {          
                filename:data.filename,
                content: smallPic,
                thumb: thumb,
                size: fileSize(smallPic),
                width: image.width,
                height: image.height
              };
        
        app.ports.processedImages.send(result);
      };
      
      image.src = data.imageData;
  }

  //**dataURL to blob**
  function dataURLtoBlob(dataurl) {
     var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
         bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
     while(n--){
         u8arr[n] = bstr.charCodeAt(n);
     }
     return new Blob([u8arr], {type:mime});
   }
  
  //**blob to dataURL**
  function blobToDataURL(blob) {
      var a = new FileReader();
      a.onload = function(e) {return (e.target.result);}
      a.readAsDataURL(blob);
  }
  
  </script>
  

  
</body>
</html>