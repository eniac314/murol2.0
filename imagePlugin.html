<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.0.0/webcomponents-bundle.js" type="text/javascript"></script>
  <script type="text/javascript" src="js/ImagePlugin.js"></script>

  <title>Main</title>


</head>

<body>
  <div id="elm"></div>
  <script type="text/javascript">
  
  var app = Elm.ImagePlugin.init({
  node: document.getElementById('elm'),
  });
  
  customElements.define('image-controller', class extends HTMLElement {

    get fileData(){
      return this._fileData || "???";
    }

    set desiredSize(maxHeight){
      if (maxHeight != null && this._original != null) {
        this._maxHeight = maxHeight;
        // resize(this._original.contents, maxHeight, this._original.filename, this);
        transform(this._original.contents,this._original.filename, this);
      }
    }
    
    set rotationAngle(rAngle){
      // console.log("test");
      if (rAngle != null && this._original != null){
        this._rAngle = rAngle;
        // rotateImage(this._original.contents, rAngle, this._original.filename, this);
        transform(this._original.contents,this._original.filename, this);
      }
    }
    

    connectedCallback() {
    
      this._input = this.querySelector('input');
      
      this._input.addEventListener('change', (event) => {
      
        var file = this._input.files[0];
        var reader = new FileReader();
        
        

        reader.onload = ((event) => {
          
          var base64encoded = event.target.result;
          
          var image = new Image();

          image.onload = () => {

            var fileData = {
              contents: base64encoded,
              filename: file.name,
              width: image.width,
              height: image.height,
              filesize: fileSize(base64encoded)
            };
            
            this._fileData = fileData;
            this._original = fileData;
            this._maxHeight = image.height;
            this._rAngle = 0;

            this.dispatchEvent(new CustomEvent('fileRead'));
          };

          image.src = base64encoded;

          
        });

        reader.readAsDataURL(file);
 
      });
    }
  });

  function fileSize(src){
    var stringLength = src.length - 'data:image/jpeg;base64,'.length;

    var sizeInBytes = 4 * Math.ceil((stringLength / 3))*0.5624896334383812;
    var sizeInKb=sizeInBytes/1024;
    return Math.round(sizeInKb);
  }

  function resize(src, max_height, filename, caller){
  
    var image = new Image();
    image.onload = function(){
      var canvas = document.createElement('canvas');
      if(image.height > max_height) {
        image.width *= max_height / image.height;
        image.height = max_height;
      }
 
        if(image.height > max_height) {
          image.width *= max_height / image.height;
          image.height = max_height; 
        }
     

      var ctx = canvas.getContext("2d");
      
      canvas.width = image.width;
      canvas.height = image.height;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0, image.width, image.height);
      var data = canvas.toDataURL("image/jpeg");  

      var fileData = {
              contents: data,
              filename: filename,
              width: image.width,
              height: image.height,
              filesize: fileSize(data)
            };
            
      caller._fileData = fileData;
      
      rotateImage(fileData.contents, caller._rAngle, caller._original.filename, caller);

      
    };
    
    image.src = src;
    }

  function rotateImage(src, rAngle, filename, caller){
    var image = new Image();
    
    image.onload = function(){
      var canvas = document.createElement('canvas');
      
      var ctx = canvas.getContext("2d");
      
      if(rAngle == 90 || rAngle == 270) {
        canvas.width = image.height;
        canvas.height = image.width;
      } else {
        canvas.width = image.width;
        canvas.height = image.height;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      

      if(rAngle == 90 || rAngle == 270) {
        ctx.translate(image.height/2,image.width/2);
      } else {
        ctx.translate(image.width/2,image.height/2);
      }
      ctx.rotate(rAngle*Math.PI/180);
      ctx.drawImage(image,-image.width/2,-image.height/2);


      var data = canvas.toDataURL("image/jpeg");  

      var fileData = {
              contents: data,
              filename: filename,
              width: canvas.width,
              height: canvas.height,
              filesize: fileSize(data)
            };
            
      caller._fileData = fileData;

      caller.dispatchEvent(new CustomEvent('imageRead'));
    };
  
  image.src = src;
  } 
  
  
  function transform(src, filename, caller){
      resize(caller._original.contents, caller._maxHeight, caller._original.filename, caller);
   
  }


  
  

    

    
  </script>
</body>
</html>